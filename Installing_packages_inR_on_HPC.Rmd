---
title: "Installing Packages in R for HPC"
output: html_notebook
---

When using R in the HPC, you'll need to ensure you have installed and loaded the relevant packages. To check what packages you have, in the R console run:

```{r show_packages}
ip <- as.data.frame(installed.packages()[,c(1,3:4)])
rownames(ip) <- NULL
ip <- ip[is.na(ip$Priority),1:2,drop=FALSE]
print(ip, row.names=FALSE)
```

To automatically install the packages you don't have, use the following function at the top of your R script that is being sources in:

```{r install_packages}
# Function to install package IF not already installed:
install_packages_not_installed = function(p) {
  if (!is.element(p, installed.packages()[,1])){
    install.packages(p, dep = TRUE)}}
```

Then for all libraries used in your script simply run the following:

```{r libraries}
install_packages_not_installed("dplyr")
install_packages_not_installed("doParallel")
install_packages_not_installed("foreach")
install_packages_not_installed("glue")
install_packages_not_installed("magrittr")
```

Aside note, when using multiple cores in parallel using %>%, you are required to load in magittr for every worker node. Simply append the 5th line to your cluster code to achieve this:

```{r magittr}
timestamp()
# setup parallel backend to use many processors
cores=detectCores()
# not to overload 
cl = makeCluster(cores[1]-1)
# Start parallel computing
registerDoParallel(cl)
clusterCall(cl, function() library(magrittr)) #required library for every node

y_sim = foreach(m=1:N, .combine=rbind) %dopar% {
  simLOB_temp = Sim_OB(prior_mat$lambda_0s[m], prior_mat$C_lams[m], mean_q, q_taker0, prior_mat$deltas[m], TimeHorizon=L, Na, prior_mat$alphas[m], 
                  prior_mat$mus[m], q_provider)
  simLOB_temp # Equivalent to y_sim= rbind(y_sim, simLOB_temp)
}

#-------------------------------------------------------------------------------------
# c) Stop parallel computing
stopCluster(cl)
timestamp()
```

